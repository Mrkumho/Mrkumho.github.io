# Kubernetes 서비스 네트워킹 핵심 요약

## 1. 서비스의 필요성
- 파드(Pod)는 일시적 → IP가 자주 변경됨
- 직접 파드 간 통신보다 **서비스(Service)** 를 통해 안정적인 엔드포인트 제공
- 서비스는 고정 IP/DNS 이름으로 파드 그룹에 접근 가능하게 함

## 2. 서비스 타입 비교

| 타입         | 접근 범위       | 외부 노출 | 사용 사례                |
|--------------|----------------|-----------|--------------------------|
| **ClusterIP** | 클러스터 내부  | ❌        | DB 같은 내부 전용 서비스 |
| **NodePort**  | 클러스터 내부 + 외부 | ✅        | 웹 애플리케이션 노출     |

## 3. 서비스 동작 원리

### 3.1 IP 할당
- 서비스 생성 시 **미리 정의된 대역**에서 IP 자동 할당
  - 대역 설정: `kube-apiserver --service-cluster-ip-range=10.96.0.0/12`
- 파드 네트워크 대역(예: `10.244.0.0/16`)과 **반드시 분리**되어야 함

### 3.2 트래픽 전달
- **kube-proxy**가 핵심 역할 수행:
  - 모든 노드에서 실행되는 데몬
  - API 서버를 감시해 서비스/파드 변경 감지
  - **iptables/IPVS 규칙**으로 트래픽 전달 설정

### 3.3 실제 전달 과정
1. 파드가 서비스 IP(`10.103.132.104:3306`)로 요청
2. 노드의 iptables에서 DNAT 규칙 적용:
```bash
iptables -t nat -L
DNAT tcp -- 0.0.0.0/0 10.103.132.104 tcp dpt:3306 to:10.244.1.2:3306
```

3. 요청이 실제 파드 IP(`10.244.1.2:3306`)로 전달

## 4. NodePort 서비스 추가 동작
- **모든 노드의 특정 포트**(30000-32767 범위) 개방
- 외부 요청 → 노드 IP:포트 → 서비스 IP → 파드 IP로 연계
- iptables에 추가 규칙 생성:
NodePort 31000 → 서비스 IP 전환
```bash
DNAT tcp -- 0.0.0.0/0 * tcp dpt:31000 to:10.103.132.104:3306
```

## 5. kube-proxy 모드 비교

| 모드          | 동작 방식                     | 성능     | 기본값 |
|---------------|------------------------------|----------|--------|
| **iptables**  | 커널 레벨에서 규칙 적용      | ⭐⭐      | ✅      |
| **IPVS**      | L4 로드밸런싱 사용           | ⭐⭐⭐     |        |
| **userspace** | kube-proxy가 직접 프록시 처리 | ⭐        |        |

> ℹ️ `kube-proxy --proxy-mode=iptables`로 모드 설정

## 6. 트러블슈팅 팁
1. **서비스 IP 할당 확인**:
```bash  
kubectl get service
```

2. **iptables 규칙 확인**:
```bash
iptables -t nat -L | grep <서비스명>
```

3. **kube-proxy 로그**:
```bash
journalctl -u kube-proxy -f
```

---

> **핵심 정리**:  
> - 서비스는 가상 IP를 통해 파드 그룹에 접근 제공  
> - kube-proxy가 iptables/IPVS로 실제 전달 규칙 생성  
> - ClusterIP(내부 전용) vs NodePort(외부 노출)  
> - 파드/서비스 네트워크 대역은 반드시 분리할 것!
